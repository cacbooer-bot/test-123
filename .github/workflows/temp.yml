name: Remote Desktop via Cloudflare
on: workflow_dispatch

jobs:
  desktop:                                                                      runs-on: ubuntu-latest
    timeout-minutes: 360  # Maximum allowed by GitHub Free tier

    steps:
      - name: Start Desktop (noVNC)
        run: |
          # We use --shm-size=2g to prevent browser crashes inside the desktop
          docker run -d \
            --name desktop \
            -p 6080:80 \                                                                -e VNC_PASSWORD=headless \
            --shm-size=2g \                                                             dorowu/ubuntu-desktop-lxde-vnc

          # Wait 10 seconds to ensure the container is fully up
          sleep 10
          docker ps

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Expose to Internet
        run: |
          # This command blocks execution and keeps the job running                   # Look at the GitHub Action logs to find the "trycloudflare.com" URL
          cloudflared tunnel --url http://localhost:6080