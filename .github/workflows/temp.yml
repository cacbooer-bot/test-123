name: Full Kali Linux (Standard Tools)
on: workflow_dispatch

jobs:
  kali-full:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Start Kali (Background)
        run: |
          # Starting the base graphical container
          docker run -d \
            --name kali \
            -p 6901:6901 \
            -e VNC_PW=headless \
            -e VNC_USER=kasm_user \
            --shm-size=2g \
            kasmweb/core-kali-rolling:1.15.0

      - name: Install "Full" Toolset (Takes ~10 mins)
        run: |
          echo "Updating repositories..."
          docker exec -u 0 kali apt-get update
          
          echo "Installing Standard Kali Tools (Metasploit, Burp, Nmap, etc)..."
          # kali-linux-default is the standard package list found in the ISO
          # We use DEBIAN_FRONTEND=noninteractive to prevent it from asking questions
          docker exec -u 0 -e DEBIAN_FRONTEND=noninteractive kali apt-get install -y kali-linux-default
          
          echo "Installation complete!"

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Expose to Internet
        run: |
          # Kasm uses HTTPS by default
          cloudflared tunnel --url https://localhost:6901 --no-tls-verify
