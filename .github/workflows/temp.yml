name: Full Kali Linux (Key Fix)
on: workflow_dispatch

jobs:
  kali-full:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Start Kali (Background)
        run: |
          docker run -d \
            --name kali \
            -p 6901:6901 \
            -e VNC_PW=headless \
            -e VNC_USER=kasm_user \
            --shm-size=2g \
            kasmweb/core-kali-rolling:1.15.0
          
          echo "Waiting for container to initialize..."
          sleep 10

      - name: Fix Keys & Install Tools (Takes ~10 mins)
        run: |
          echo "Step 1: Forcing key update..."
          # 1. Update list allowing insecure (expired) keys
          docker exec -u 0 kali apt-get update --allow-insecure-repositories
          
          # 2. Install the new valid keyring
          docker exec -u 0 -e DEBIAN_FRONTEND=noninteractive kali apt-get install -y --allow-unauthenticated kali-archive-keyring
          
          echo "Step 2: Installing Full Toolset..."
          # 3. Now update normally and install the big package
          docker exec -u 0 kali apt-get update
          docker exec -u 0 -e DEBIAN_FRONTEND=noninteractive kali apt-get install -y kali-linux-default
          
          echo "Installation complete!"

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Expose to Internet
        run: |
          cloudflared tunnel --url https://localhost:6901 --no-tls-verify
