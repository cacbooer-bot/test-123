name: Remote Linux Desktop
on: workflow_dispatch

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Start Linux Desktop (XFCE + Firefox)
        run: |
          # We use a more robust image that includes a browser
          # and better performance for remote viewing.
          docker run -d \
            --name linux-vm \
            -p 6080:6080 \
            -e PUID=1000 -e PGID=1000 \
            -e TZ=Etc/UTC \
            -e VNC_PASSWORD=headless \
            --shm-size=2g \
            lscr.io/linuxserver/firefox:latest
            
          sleep 15 # Wait for the browser/desktop to initialize

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Expose to Internet
        run: |
          echo "---------------------------------------------------"
          echo "GO TO THE URL BELOW TO ACCESS YOUR DESKTOP"
          echo "---------------------------------------------------"
          # This will provide a random .trycloudflare.com link in the logs
          cloudflared tunnel --url http://localhost:3000