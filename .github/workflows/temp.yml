name: Kali Linux Desktop (Cloudflare)
on: workflow_dispatch

jobs:
  kali-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Start Kali Linux (Kasm)
        run: |
          docker run -d \
            --name kali \
            --user root \
            -p 6901:6901 \
            -e VNC_PW=headless \
            -e VNC_USER=admin \
            --shm-size=2g \
            kasmweb/kali-rolling-desktop
            
          echo "Kali is starting... waiting 30 seconds for GUI to initialize..."
          sleep 30
          docker ps

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Expose to Internet
        run: |
          # We use --no-tls-verify because Kasm uses self-signed HTTPS
          cloudflared tunnel --url https://localhost:6901 --no-tls-verify
