name: VNC via Guacamole

on:
  workflow_dispatch:

jobs:
  desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Install Docker
        run: |
          sudo apt update
          sudo apt install -y docker.io docker-compose
          sudo systemctl start docker
          sudo systemctl enable docker

      - name: Create docker-compose.yml
        run: |
          cat << 'EOF' > docker-compose.yml
          version: "3.8"

          services:
            tigervnc:
              image: dorowu/ubuntu-desktop-lxde-vnc
              container_name: tigervnc
              environment:
                - VNC_PASSWORD=1234
              ports:
                - "5901:5901"

            guacd:
              image: guacamole/guacd
              container_name: guacd

            guacamole:
              image: guacamole/guacamole
              container_name: guacamole
              depends_on:
                - guacd
                - tigervnc
              environment:
                GUACD_HOSTNAME: guacd
                GUACD_PORT: 4822
              ports:
                - "8080:8080"
          EOF

      - name: Start VNC + Guacamole
        run: |
          docker-compose up -d
          docker ps

      - name: Install Cloudflare Tunnel
        run: |
          wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared-linux-amd64
          sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

      - name: Expose Guacamole to Internet
        run: |
          cloudflared tunnel --url http://localhost:8080