name: Kali Linux (Fixed)
on: workflow_dispatch

jobs:
  kali-desktop:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Start Kali Linux (Kasm Core)
        run: |
          # Using the correct repo: kasmweb/core-kali-rolling
          # Using specific tag: 1.15.0 (latest tag does not exist for this image)
          docker run -d \
            --name kali \
            --user root \
            -p 6901:6901 \
            -e VNC_PW=headless \
            -e VNC_USER=kasm_user \
            --shm-size=2g \
            kasmweb/core-kali-rolling:1.15.0
            
          echo "Kali is starting... waiting 30 seconds..."
          sleep 30
          docker ps

      - name: Install Cloudflared
        run: |
          curl -L --output cloudflared.deb https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb
          sudo dpkg -i cloudflared.deb

      - name: Expose to Internet
        run: |
          # Kasm uses HTTPS by default, so we point to https://localhost:6901
          # We must use --no-tls-verify because the certificate is self-signed
          cloudflared tunnel --url https://localhost:6901 --no-tls-verify
